/*
===============================================================================
    Author:     Eric M. Barnard - @ericmbarnard                                
    License:    MIT (http://opensource.org/licenses/mit-license.php)           
                                                                               
    Description: Validation Library for KnockoutJS                             
===============================================================================
*/
(function(e){typeof require=="function"&&typeof exports=="object"&&typeof module=="object"?e(require("knockout"),exports):typeof define=="function"&&define.amd?define(["knockout","exports"],e):e(ko,ko.validation={})})(function(e,t){function n(e,n,r){return n.validator(e(),r.params===undefined?!0:r.params)?!0:(e.error=t.formatMessage(r.message||n.message,r.params),e.__valid__(!1),!1)}function r(e,n,r){e.isValidating(!0);var i=function(i){var s=!1,o="";if(!e.__valid__()){e.isValidating(!1);return}i.message?(s=i.isValid,o=i.message):s=i,s||(e.error=t.formatMessage(o||r.message||n.message,r.params),e.__valid__(s)),e.isValidating(!1)};n.validator(e(),r.params||!0,i)}if(typeof e===undefined)throw"Knockout is required, please ensure it is loaded before loading this validation plug-in";var i=t;e.validation=i;var s={registerExtenders:!0,messagesOnModified:!0,errorsAsTitle:!0,errorsAsTitleOnModified:!1,messageTemplate:null,insertMessages:!0,parseInputAttributes:!1,writeInputAttributes:!1,decorateElement:!1,errorClass:null,errorElementClass:"validationElement",errorMessageClass:"validationMessage",grouping:{deep:!1,observable:!0}},o=e.utils.extend({},s),u=["required","pattern","min","max","step"],a=["email","number","date"],f=function(e){window.setImmediate?window.setImmediate(e):window.setTimeout(e,0)},l=function(){var e=(new Date).getTime(),t={},n="__ko_validation__";return{isArray:function(e){return e.isArray||Object.prototype.toString.call(e)==="[object Array]"},isObject:function(e){return e!==null&&typeof e=="object"},values:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t},getValue:function(e){return typeof e=="function"?e():e},hasAttribute:function(e,t){return e.getAttribute(t)!==null},getAttribute:function(e,t){return e.getAttribute(t)},setAttribute:function(e,t,n){return e.setAttribute(t,n)},isValidatable:function(e){return e&&e.rules&&e.isValid&&e.isModified},insertAfter:function(e,t){e.parentNode.insertBefore(t,e.nextSibling)},newId:function(){return e+=1},getConfigOptions:function(e){var t=l.contextFor(e);return t||o},setDomData:function(e,r){var i=e[n];i||(e[n]=i=l.newId()),t[i]=r},getDomData:function(e){var r=e[n];return r?t[r]:undefined},contextFor:function(e){switch(e.nodeType){case 1:case 8:var t=l.getDomData(e);if(t)return t;if(e.parentNode)return l.contextFor(e.parentNode)}return undefined},isEmptyVal:function(e){if(e===undefined)return!0;if(e===null)return!0;if(e==="")return!0}}}(),c=function(){var n=0;return{utils:l,init:function(r,i){if(n>0&&!i)return;r=r||{},r.errorElementClass=r.errorElementClass||r.errorClass||o.errorElementClass,r.errorMessageClass=r.errorMessageClass||r.errorClass||o.errorMessageClass,e.utils.extend(o,r),o.registerExtenders&&t.registerExtenders(),n=1},configure:function(e){t.init(e)},reset:function(){o=$.extend(o,s)},group:function(t,n){var n=e.utils.extend(o.grouping,n),r=e.observableArray([]),i=null,s=function u(t,i){var s=[],o=e.utils.unwrapObservable(t);i=i!==undefined?i:n.deep?1:-1,e.isObservable(t)&&(t.isValid||t.extend({validatable:!0}),r.push(t)),o&&(l.isArray(o)?s=o:l.isObject(o)&&(s=l.values(o))),i!==0&&e.utils.arrayForEach(s,function(e){e&&!e.nodeType&&u(e,i+1)})};return n.observable?(s(t),i=e.computed(function(){var t=[];return e.utils.arrayForEach(r(),function(e){e.isValid()||t.push(e.error)}),t})):i=function(){var n=[];return r([]),s(t),e.utils.arrayForEach(r(),function(e){e.isValid()||n.push(e.error)}),n},i.showAllMessages=function(t){t==undefined&&(t=!0),i(),e.utils.arrayForEach(r(),function(e){e.isModified(t)})},t.errors=i,t.isValid=function(){return t.errors().length===0},t.isAnyMessageShown=function(){var t=!1;return i(),e.utils.arrayForEach(r(),function(e){!e.isValid()&&e.isModified()&&(t=!0)}),t},i},formatMessage:function(e,t){return typeof e=="function"?e(t):e.replace(/\{0\}/gi,t)},addRule:function(e,t){return e.extend({validatable:!0}),e.rules.push(t),e},addAnonymousRule:function(e,n){var r=l.newId();n.message===undefined&&(n.message="Error"),t.rules[r]=n,t.addRule(e,{rule:r,params:n.params})},addExtender:function(n){e.extenders[n]=function(e,r){return r.message||r.onlyIf?t.addRule(e,{rule:n,message:r.message,params:l.isEmptyVal(r.params)?!0:r.params,condition:r.onlyIf}):t.addRule(e,{rule:n,params:r})}},registerExtenders:function(){if(o.registerExtenders)for(var n in t.rules)t.rules.hasOwnProperty(n)&&(e.extenders[n]||t.addExtender(n))},insertValidationMessage:function(e){var t=document.createElement("SPAN");return t.className=l.getConfigOptions(e).errorMessageClass,l.insertAfter(e,t),t},parseInputValidationAttributes:function(n,r){e.utils.arrayForEach(u,function(e){l.hasAttribute(n,e)&&t.addRule(r(),{rule:e,params:n.getAttribute(e)||!0})});var i=n.getAttribute("type");e.utils.arrayForEach(a,function(e){e==i&&t.addRule(r(),{rule:e=="date"?"dateISO":e,params:!0})})},writeInputValidationAttributes:function(t,n){var r=n();if(!r||!r.rules)return;var i=r.rules();e.utils.arrayForEach(u,function(n){var r,s=e.utils.arrayFirst(i,function(e){return e.rule.toLowerCase()===n.toLowerCase()});if(!s)return;r=s.params,s.rule=="pattern"&&s.params instanceof RegExp&&(r=s.params.source),t.setAttribute(n,r)}),i=null}}}();e.utils.extend(i,c),i.rules={},i.rules.required={validator:function(e,t){var n=/^\s+|\s+$/g,r;return e===undefined||e===null?!t:(r=e,typeof e=="string"&&(r=e.replace(n,"")),t?(r+"").length>0:!0)},message:"This field is required."},i.rules.min={validator:function(e,t){return l.isEmptyVal(e)||e>=t},message:"Please enter a value greater than or equal to {0}."},i.rules.max={validator:function(e,t){return l.isEmptyVal(e)||e<=t},message:"Please enter a value less than or equal to {0}."},i.rules.minLength={validator:function(e,t){return l.isEmptyVal(e)||e.length>=t},message:"Please enter at least {0} characters."},i.rules.maxLength={validator:function(e,t){return l.isEmptyVal(e)||e.length<=t},message:"Please enter no more than {0} characters."},i.rules.pattern={validator:function(e,t){return l.isEmptyVal(e)||e.toString().match(t)!=null},message:"Please check this value."},i.rules.step={validator:function(e,t){return l.isEmptyVal(e)||e*100%(t*100)===0},message:"The value must increment by {0}"},i.rules.email={validator:function(e,t){return t?l.isEmptyVal(e)||t&&/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i.test(e):!0},message:"Please enter a proper email address"},i.rules.date={validator:function(e,t){return t?l.isEmptyVal(e)||t&&!/Invalid|NaN/.test(new Date(e)):!0},message:"Please enter a proper date"},i.rules.dateISO={validator:function(e,t){return t?l.isEmptyVal(e)||t&&/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(e):!0},message:"Please enter a proper date"},i.rules.number={validator:function(e,t){return t?l.isEmptyVal(e)||t&&/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test(e):!0},message:"Please enter a number"},i.rules.digit={validator:function(e,t){return t?l.isEmptyVal(e)||t&&/^\d+$/.test(e):!0},message:"Please enter a digit"},i.rules.phoneUS={validator:function(e,t){return t?typeof e!="string"?!1:l.isEmptyVal(e)?!0:(e=e.replace(/\s+/g,""),t&&e.length>9&&e.match(/^(1-?)?(\([2-9]\d{2}\)|[2-9]\d{2})-?[2-9]\d{2}-?\d{4}$/)):!0},message:"Please specify a valid phone number"},i.rules.equal={validator:function(e,t){var n=t;return e===l.getValue(n)},message:"Values must equal"},i.rules.notEqual={validator:function(e,t){var n=t;return e!==l.getValue(n)},message:"Please choose another value."},i.rules.unique={validator:function(t,n){var r=l.getValue(n.collection),i=l.getValue(n.externalValue),s=0;return!t||!r?!0:(e.utils.arrayFilter(e.utils.unwrapObservable(r),function(e){t===(n.valueAccessor?n.valueAccessor(e):e)&&s++}),s<(i!==undefined&&t!==i?1:2))},message:"Please make sure the value is unique."},function(){i.registerExtenders()}(),e.bindingHandlers.validationCore=function(){return{init:function(n,r,i,s,o){var u=l.getConfigOptions(n);u.parseInputAttributes&&f(function(){t.parseInputValidationAttributes(n,r)});if(u.insertMessages&&l.isValidatable(r())){var a=t.insertValidationMessage(n);u.messageTemplate?e.renderTemplate(u.messageTemplate,{field:r()},null,a,"replaceNode"):e.applyBindingsToNode(a,{validationMessage:r()})}u.writeInputAttributes&&l.isValidatable(r())&&t.writeInputValidationAttributes(n,r),u.decorateElement&&l.isValidatable(r())&&e.applyBindingsToNode(n,{validationElement:r()})},update:function(e,t,n,r,i){}}}(),function(){var t=e.bindingHandlers.value.init;e.bindingHandlers.value.init=function(n,r,i,s,o){return t(n,r,i),e.bindingHandlers.validationCore.init(n,r,i,s,o)}}(),e.bindingHandlers.validationMessage={update:function(t,n){var r=n(),i=l.getConfigOptions(t),s=e.utils.unwrapObservable(r),o=null,u=!1,a=!1;r.extend({validatable:!0}),u=r.isModified(),a=r.isValid();var f=function(){return!i.messagesOnModified||u?a?null:r.error:null},c=function(){return!i.messagesOnModified||u?!a:!1};e.bindingHandlers.text.update(t,f),e.bindingHandlers.visible.update(t,c)}},e.bindingHandlers.validationElement={update:function(t,n){var r=n(),i=l.getConfigOptions(t),s=e.utils.unwrapObservable(r),o=null,u=!1,a=!1;r.extend({validatable:!0}),u=r.isModified(),a=r.isValid();var f=function(){var e={},t=u?!a:!1;return i.decorateElement||(t=!1),e[i.errorElementClass]=t,e};e.bindingHandlers.css.update(t,f);if(!i.errorsAsTitle)return;var c=l.getAttribute(t,"data-orig-title"),h=t.title,p=l.getAttribute(t,"data-orig-title")=="true",d=function(){if(!i.errorsAsTitleOnModified||u)return a?{title:c||h,"data-orig-title":null}:{title:r.error,"data-orig-title":c||h}};e.bindingHandlers.attr.update(t,d)}},e.bindingHandlers.validationOptions=function(){return{init:function(t,n,r,i,s){var u=e.utils.unwrapObservable(n());if(u){var a=e.utils.extend({},o);e.utils.extend(a,u),l.setDomData(t,a)}}}}(),e.extenders.validation=function(n,r){return e.utils.arrayForEach(l.isArray(r)?r:[r],function(e){t.addAnonymousRule(n,e)}),n},e.extenders.validatable=function(n,r){if(r&&!l.isValidatable(n)){n.error=null,n.rules=e.observableArray(),n.isValidating=e.observable(!1),n.__valid__=e.observable(!0),n.isModified=e.observable(!1);var i=e.computed(function(){var e=n(),r=n.rules();return t.validateObservable(n),!0});n.isValid=e.computed(function(){return n.__valid__()});var s=n.subscribe(function(){n.isModified(!0)});n._disposeValidation=function(){n.isValid.dispose(),n.rules.removeAll(),n.isModified._subscriptions.change=[],n.isValidating._subscriptions.change=[],n.__valid__._subscriptions.change=[],s.dispose(),i.dispose(),delete n.rules,delete n.error,delete n.isValid,delete n.isValidating,delete n.__valid__,delete n.isModified}}else r===!1&&l.isValidatable(n)&&n._disposeValidation&&n._disposeValidation();return n},i.validateObservable=function(e){var i=0,s,o,u=e.rules(),a=u.length;for(;i<a;i++){o=u[i];if(o.condition&&!o.condition())continue;s=t.rules[o.rule];if(s.async||o.async)r(e,s,o);else if(!n(e,s,o))return!1}return e.error=null,e.__valid__(!0),!0},e.validatedObservable=function(n){if(!t.utils.isObject(n))return e.observable(n).extend({validatable:!0});var r=e.observable(n);return r.errors=t.group(n),r.isValid=e.computed(function(){return r.errors().length===0}),r},i.localize=function(e){var n,r;for(r in e)t.rules.hasOwnProperty(r)&&(t.rules[r].message=e[r])},e.applyBindingsWithValidation=function(n,r,i){var s=arguments.length,o,u;s>2?(o=r,u=i):s<2?o=document.body:arguments[1].nodeType?o=r:u=arguments[1],t.init(),u&&t.utils.setDomData(o,u),e.applyBindings(n,r)};var h=e.applyBindings;e.applyBindings=function(e,n){t.init(),h(e,n)}});